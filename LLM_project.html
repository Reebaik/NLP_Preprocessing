<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Code Explainer</title>
    <!-- Use the Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d1a;
        }
        /* Custom styles for markdown content */
        .markdown-content pre {
            background-color: #1a202c;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
        .markdown-content code {
            font-family: "Courier New", Courier, monospace;
        }
        /* Pulse animation for the button */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        .animate-pulse-once:hover {
            animation: pulse 1s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen p-4">

    <!-- Main Container -->
    <div class="bg-gray-800 rounded-2xl shadow-2xl overflow-hidden w-full max-w-2xl transform transition-all duration-300 scale-100">
        
        <!-- Header -->
        <header class="p-8 bg-gray-900 text-white text-center shadow-lg">
            <h1 class="text-3xl sm:text-4xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-500">
                AI Code Explainer
            </h1>
            <p class="text-gray-300 text-sm sm:text-base">Paste your code below to get a detailed explanation.</p>
        </header>

        <!-- Main Content Area -->
        <main class="p-6">
            <!-- Code Input Area -->
            <div class="mb-6">
                <label for="codeInput" class="block text-gray-300 font-semibold mb-2">Enter Code to Explain</label>
                <textarea
                    id="codeInput"
                    class="w-full h-48 p-4 border border-gray-700 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none transition-all duration-300 text-sm placeholder:text-gray-400"
                    placeholder="Paste your code snippet here (e.g., Python, JavaScript, etc.)..."
                ></textarea>
            </div>

            <!-- Explain Button -->
            <div class="flex items-center justify-center mb-6">
                <button
                    id="explainBtn"
                    class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-bold rounded-full shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500/50 transition-all duration-300 flex items-center justify-center transform hover:scale-105 animate-pulse-once"
                >
                    <svg id="buttonIcon" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="buttonText">Explain Code</span>
                </button>
            </div>

            <!-- Explanation Output Area -->
            <div id="explanationOutput" class="hidden opacity-0 translate-y-4 transition-all duration-500 ease-in-out">
                <h2 class="text-gray-300 font-semibold mb-2">Explanation</h2>
                <div class="bg-gray-700 border border-gray-600 rounded-lg p-4 markdown-content">
                    <p id="explanationText" class="text-gray-200 leading-relaxed text-sm"></p>
                </div>
            </div>
        </main>
        
        <!-- Footer for API Key Information -->
        <footer class="p-4 text-center text-xs text-gray-600 border-t border-gray-700">
            Powered by the Gemini API.
        </footer>
    </div>

    <script type="text/javascript">
        // Get references to DOM elements
        const codeInput = document.getElementById('codeInput');
        const explainBtn = document.getElementById('explainBtn');
        const buttonText = document.getElementById('buttonText');
        const buttonIcon = document.getElementById('buttonIcon');
        const explanationOutput = document.getElementById('explanationOutput');
        const explanationText = document.getElementById('explanationText');

        // A function to convert Markdown to HTML. A simple one for this use case.
        function markdownToHtml(markdown) {
            let html = markdown
                .replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold text-white mt-4 mb-2">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold text-white mt-6 mb-3">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-extrabold text-white mt-8 mb-4">$1</h1>')
                .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/gim, '<em>$1</em>')
                .replace(/`([^`]+)`/g, '<code class="bg-gray-600 text-white rounded px-1 py-0.5">$1</code>');
            
            // Handle code blocks
            html = html.replace(/```(.*?)\n([\s\S]*?)```/g, function(match, lang, code) {
                return `<pre class="bg-gray-900 text-gray-200 p-4 rounded-lg mt-2 mb-4 overflow-x-auto text-sm"><code>${code.trim()}</code></pre>`;
            });

            // Handle new lines
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        // Main function to handle the explanation process
        explainBtn.addEventListener('click', async () => {
            const codeToExplain = codeInput.value.trim();

            // Validate that the input text is not empty
            if (codeToExplain === "") {
                showMessage("Please enter some code to explain.", "text-red-400");
                return;
            }

            // Show loading state
            toggleLoading(true);

            try {
                // Construct the prompt for the LLM
                const userPrompt = `Provide a detailed, line-by-line explanation of the following code snippet. Break down the logic and purpose of each major section. The output should be formatted using Markdown for readability, including code blocks where appropriate:\n\n\`\`\`\n${codeToExplain}\n\`\`\``;
                
                // Define the API payload
                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                };

                // Fetch the API key. In this environment, it's provided automatically.
                const apiKey = "AIzaSyAuWDovDHB0Mbti0rYlbQHleOfVlRNf6Qo";
                
                // Add an explicit check for the API key
                if (!apiKey) {
                    showMessage("API key is not available. Please try again later.", "text-red-400");
                    toggleLoading(false);
                    return;
                }

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                // Retry logic with exponential backoff
                const maxRetries = 3;
                let retryCount = 0;
                let response = null;

                while (retryCount < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            break; // Success, exit the retry loop
                        } else {
                            throw new Error(`API response was not OK. Status: ${response.status}`);
                        }
                    } catch (error) {
                        retryCount++;
                        console.error(`Attempt ${retryCount} failed:`, error);
                        if (retryCount < maxRetries) {
                            // Wait before retrying with exponential backoff
                            const delay = Math.pow(2, retryCount) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            throw error; // Re-throw the error if max retries are reached
                        }
                    }
                }

                if (!response || !response.ok) {
                    throw new Error("Failed to get a response from the API after multiple retries.");
                }

                const result = await response.json();
                const explanation = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (explanation) {
                    // Update the UI with the explanation and show the output area
                    explanationText.innerHTML = markdownToHtml(explanation.trim());
                    explanationOutput.classList.remove('hidden', 'opacity-0', 'translate-y-4');
                    showMessage("Explanation generated successfully!", "text-green-400");
                } else {
                    showMessage("Could not generate an explanation. Please try again.", "text-red-400");
                    explanationOutput.classList.add('hidden', 'opacity-0', 'translate-y-4');
                }

            } catch (error) {
                console.error("Error during explanation:", error);
                showMessage("An error occurred. Please check the console.", "text-red-400");
                explanationOutput.classList.add('hidden', 'opacity-0', 'translate-y-4');
            } finally {
                // Hide loading state
                toggleLoading(false);
            }
        });

        // Toggles the loading state of the button
        function toggleLoading(isLoading) {
            if (isLoading) {
                explainBtn.disabled = true;
                buttonText.classList.add('hidden');
                buttonIcon.classList.remove('hidden');
                explanationText.innerText = "";
            } else {
                explainBtn.disabled = false;
                buttonText.classList.remove('hidden');
                buttonIcon.classList.add('hidden');
            }
        }

        // Displays a temporary message to the user
        function showMessage(message, colorClass) {
            const tempMessageEl = document.createElement('p');
            tempMessageEl.className = `mt-4 text-center text-sm font-medium ${colorClass}`;
            tempMessageEl.innerText = message;
            
            const messageArea = document.querySelector('main > div:last-child');
            messageArea.parentNode.insertBefore(tempMessageEl, messageArea.nextSibling);

            setTimeout(() => {
                tempMessageEl.remove();
            }, 5000); // Remove message after 5 seconds
        }

    </script>
</body>
</html>
